<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab Status | Docker Virtual Lab</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Docker Virtual Lab</h1>
        <p class="subtitle">Check your lab access status</p>
      </header>

      <nav>
        <a href="/">Request Access</a>
        <a href="/status" class="active">Check Status</a>
      </nav>

      <main>
        <div class="card">
          <h2>Your Lab Status</h2>
          <p class="info-text">
            Enter your email address to check if your Docker lab access has been
            approved.
          </p>

          <form id="statusForm">
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required />
            </div>

            <button type="submit" class="btn btn-primary">Check Status</button>
          </form>

          <div id="statusResult" style="display: none">
            <div class="status-card">
              <h3>Lab Access Status</h3>

              <div class="status-row">
                <span class="label">Student Name:</span>
                <span id="studentName"></span>
              </div>

              <div class="status-row">
                <span class="label">Lab:</span>
                <span id="labName"></span>
              </div>

              <div class="status-row">
                <span class="label">Environment:</span>
                <span>Ubuntu + Docker</span>
              </div>

              <div class="status-row">
                <span class="label">Access Type:</span>
                <span>Terminal-based</span>
              </div>

              <div class="status-row">
                <span class="label">Status:</span>
                <span id="status" class="status-badge"></span>
              </div>

              <div id="labUrlSection" style="display: none">
                <div class="status-row">
                  <span class="label">Lab URL:</span>
                  <a id="labUrl" href="" target="_blank" class="lab-link"></a>
                </div>
                <a
                  id="labUrlButton"
                  href=""
                  target="_blank"
                  class="btn btn-primary"
                  style="display: inline-block; margin-top: 20px"
                  >Open Docker Lab</a
                >
                <p class="info-text" style="margin-top: 15px">
                  This opens a live Docker terminal in your browser.
                </p>
              </div>

              <div id="pendingMessage" style="display: none">
                <p class="info-text">
                  Your request is being reviewed. You will receive access once
                  an administrator approves your request.
                </p>
              </div>
            </div>
          </div>

          <div id="noRequestMessage" style="display: none">
            <div class="status-card">
              <p class="info-text">
                No active request found for this email address.
                <a href="/">Submit a new request</a>.
              </p>
            </div>
          </div>

          <div id="messageBox" class="message" style="display: none"></div>
        </div>
      </main>

      <footer>
        <p>Docker Virtual Lab | Hands-on Learning Prototype</p>
      </footer>
    </div>

    <script>
      const form = document.getElementById("statusForm");
      const statusResult = document.getElementById("statusResult");
      const noRequestMessage = document.getElementById("noRequestMessage");
      const messageBox = document.getElementById("messageBox");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();

        // Hide previous results
        statusResult.style.display = "none";
        noRequestMessage.style.display = "none";
        messageBox.style.display = "none";

        try {
          const response = await fetch(
            `/api/status?email=${encodeURIComponent(email)}`
          );
          const data = await response.json();

          if (response.ok) {
            if (data.found) {
              displayStatus(data);
            } else {
              noRequestMessage.style.display = "block";
            }
          } else {
            showMessage("error", data.error || "Failed to fetch status");
          }
        } catch (error) {
          showMessage("error", "Network error. Please try again.");
        }
      });

      function displayStatus(data) {
        document.getElementById("studentName").textContent = data.name;
        document.getElementById("labName").textContent = data.labName;

        const statusBadge = document.getElementById("status");
        statusBadge.textContent =
          data.status.charAt(0).toUpperCase() + data.status.slice(1);
        statusBadge.className = "status-badge " + data.status;

        if (data.status === "approved" && data.labUrl) {
          document.getElementById("labUrl").href = data.labUrl;
          document.getElementById("labUrl").textContent = data.labUrl;
          document.getElementById("labUrlButton").href = data.labUrl;
          document.getElementById("labUrlSection").style.display = "block";
          document.getElementById("pendingMessage").style.display = "none";
        } else {
          document.getElementById("labUrlSection").style.display = "none";
          document.getElementById("pendingMessage").style.display = "block";
        }

        statusResult.style.display = "block";
      }

      function showMessage(type, text) {
        messageBox.textContent = text;
        messageBox.className =
          "message " + (type === "success" ? "success" : "error");
        messageBox.style.display = "block";
      }
    </script>
  </body>
</html>
